<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Autograph Basics • tfautograph</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Autograph Basics">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tfautograph</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tfautograph.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tf-v1.html">Autographing Tensorflow version 1.15</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Autograph Basics</h1>
            
      
      
      <div class="hidden name"><code>tfautograph.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(magrittr)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co"># library(listarrays)</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co"># library(purrr)</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(reticulate)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tensorflow)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tfautograph)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tfdatasets)</a></code></pre></div>
<p>The R package <code>tfautograph</code> helps you write natural R code with tensorflow. It allows you to write R code as you would naturally, which then gets translated to tensorflow equivalent control flow statements. This vignette goes through some of the main features and then goes into how it works a little.</p>
<div id="usage" class="section level3">
<h3 class="hasAnchor">
<a href="#usage" class="anchor"></a>Usage</h3>
<p>The primary interface to autograph is the function <code><a href="../reference/autograph.html">autograph()</a></code>. It can either take a function or an expression. The following two uses are equivalent.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># pass a function to autograph()</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">fn &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="cf">if</span>(x <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) x <span class="op">*</span><span class="st"> </span>x <span class="cf">else</span> x</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">square_if_positive &lt;-<span class="st"> </span><span class="kw"><a href="../reference/autograph.html">autograph</a></span>(fn) </a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co"># pass an expression to autograph()</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">square_if_positive &lt;-<span class="st"> </span><span class="kw"><a href="../reference/autograph.html">autograph</a></span>(<span class="cf">function</span>(x) <span class="cf">if</span>(x <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) x <span class="op">*</span><span class="st"> </span>x <span class="cf">else</span> x)</a></code></pre></div>
<p>Now <code>square_if_positive</code> is a function that can accept a tensor as an argument.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">x &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">convert_to_tensor</span>(<span class="dv">5</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">y &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">convert_to_tensor</span>(<span class="op">-</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">square_if_positive</span>(x)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt; tf.Tensor(25.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">square_if_positive</span>(y)</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt; tf.Tensor(-5.0, shape=(), dtype=float32)</span></a></code></pre></div>
<p>Note that if you’re in a context where tensorflow is executing eagerly, <code><a href="../reference/autograph.html">autograph()</a></code> doesn’t change that–<code>square_if_positive()</code> is still executing eagerly. You can test that by inserting some R <code>print</code> statements to see when a branch is evaluated.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">square_if_positive_verbose &lt;-<span class="st"> </span><span class="kw"><a href="../reference/autograph.html">autograph</a></span>(<span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="cf">if</span> (x <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">    <span class="kw"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Tracing true branch"</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">    x <span class="op">*</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">    <span class="kw"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Tracing false branch"</span>)</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    x</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">  }</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">})</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="kw">square_if_positive_verbose</span>(x)</a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co">#&gt; Tracing true branch</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co">#&gt; tf.Tensor(25.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="kw">square_if_positive_verbose</span>(x)</a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co">#&gt; Tracing true branch</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="co">#&gt; tf.Tensor(25.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="kw">square_if_positive_verbose</span>(x)</a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="co">#&gt; Tracing true branch</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="co">#&gt; tf.Tensor(25.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="kw">square_if_positive_verbose</span>(y)</a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="co">#&gt; Tracing false branch</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="co">#&gt; tf.Tensor(-5.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24"><span class="kw">square_if_positive_verbose</span>(y)</a>
<a class="sourceLine" id="cb4-25" data-line-number="25"><span class="co">#&gt; Tracing false branch</span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26"><span class="co">#&gt; tf.Tensor(-5.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb4-27" data-line-number="27"><span class="kw">square_if_positive_verbose</span>(y)</a>
<a class="sourceLine" id="cb4-28" data-line-number="28"><span class="co">#&gt; Tracing false branch</span></a>
<a class="sourceLine" id="cb4-29" data-line-number="29"><span class="co">#&gt; tf.Tensor(-5.0, shape=(), dtype=float32)</span></a></code></pre></div>
<p>The easiest way to enter a context where tensorflow is not executing eagerly anymore and instead is in <strong>graph mode</strong> is to call python’s <code>tf.function()</code>. (Because <code>function</code> is a reserved word for the R parser, there is a convenient wrapper provided by the tensorflow <code>R</code> package: <code><a href="https://rdrr.io/pkg/tensorflow/man/tf_function.html">tf_function()</a></code>)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">graph_fn &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/tensorflow/man/tf_function.html">tf_function</a></span>(square_if_positive_verbose)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw">graph_fn</span>(x)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#&gt; Tracing true branch</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co">#&gt; Tracing false branch</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="co">#&gt; tf.Tensor(25.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="kw">graph_fn</span>(x)</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="co">#&gt; tf.Tensor(25.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="kw">graph_fn</span>(x)</a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="co">#&gt; tf.Tensor(25.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="kw">graph_fn</span>(y)</a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="co">#&gt; tf.Tensor(-5.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="kw">graph_fn</span>(y)</a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="co">#&gt; tf.Tensor(-5.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16"><span class="kw">graph_fn</span>(y)</a>
<a class="sourceLine" id="cb5-17" data-line-number="17"><span class="co">#&gt; tf.Tensor(-5.0, shape=(), dtype=float32)</span></a></code></pre></div>
<p>In graph mode, both branches of the <code>if</code> expression are traced into a tensorflow graph the first time the function is called and the resultant graph is cached by <code>tf.function()</code>. Then on subsequent calls only the cached graph is evaluated.</p>
<p>The key takeaways are that <code><a href="../reference/autograph.html">autograph()</a></code> helps you write natural R code and use tensors in expressions where R wouldn’t otherwise accept them. And that <code>autograph</code> is smart enough to do the right thing in both eager mode and graph mode.</p>
</div>
<div id="control-flow" class="section level3">
<h3 class="hasAnchor">
<a href="#control-flow" class="anchor"></a>Control Flow</h3>
<p>The most prominent and used feature of tfautograph is the fact that it will translate control flow statements. This includes <code>if</code>, <code>while</code>, <code>for</code>, <code>break</code>, <code>next</code>, and <code>switch</code>. Here is handy summary table of the translation endpoints.</p>
<table class="table">
<thead><tr class="header">
<th align="left">R expression</th>
<th align="left">Graph Mode Translation</th>
<th align="left">Eager Mode Translation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><code>if(x)</code></td>
<td align="left"><code>tf$cond(x, ...)</code></td>
<td align="left"><code>if(x$`__bool__`())</code></td>
</tr>
<tr class="even">
<td align="left"><code>while(x)</code></td>
<td align="left"><code>tf$while_loop(...)</code></td>
<td align="left"><code>while(as.logical(x))</code></td>
</tr>
<tr class="odd">
<td align="left"><code>for(x in tensor)</code></td>
<td align="left"><code>tf$while_loop(...)</code></td>
<td align="left"><code>while(!is.null(x &lt;- iter_next(tensor))</code></td>
</tr>
<tr class="even">
<td align="left"><code>for(x in tfdataset)</code></td>
<td align="left"><code>Dataset$reduce()</code></td>
<td align="left"><code>while(!is.null(x &lt;- iter_next(dataset))</code></td>
</tr>
</tbody>
</table>
<p>Lets go through them one at a time.</p>
<div id="if" class="section level4">
<h4 class="hasAnchor">
<a href="#if" class="anchor"></a><code>if</code>
</h4>
<p><code>if</code> statements written in R automatically get translated to a <code>tf.cond()</code> call in graph mode. Both locally modified and/or created variables, as well as the return value of the overall expression are captured as part of the constructed <code>tf.cond()</code>. Unbalanced branches are automatically balanced to satisfy the requirements of <code>tf.cond()</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">tf_sign &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/tensorflow/man/tf_function.html">tf_function</a></span>(<span class="kw"><a href="../reference/autograph.html">autograph</a></span>(<span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  numeric_sign &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  string_sign &lt;-<span class="st"> </span><span class="cf">if</span> (x <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">    <span class="kw"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Tracing positive branch"</span>)</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">    numeric_sign &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">    <span class="st">"positive"</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">  } <span class="cf">else</span> <span class="cf">if</span> (x <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">    <span class="kw"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Tracing negative branch"</span>)</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    numeric_sign &lt;-<span class="st"> </span><span class="dv">-1</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">    <span class="st">"negative"</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">    <span class="kw"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Tracing zero branch"</span>)</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">    <span class="st">"zero"</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14">  }</a>
<a class="sourceLine" id="cb6-15" data-line-number="15">  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(numeric_sign, string_sign)</a>
<a class="sourceLine" id="cb6-16" data-line-number="16">}))</a>
<a class="sourceLine" id="cb6-17" data-line-number="17"></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="kw">tf_sign</span>(x)</a>
<a class="sourceLine" id="cb6-19" data-line-number="19"><span class="co">#&gt; Tracing positive branch</span></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"><span class="co">#&gt; Tracing negative branch</span></a>
<a class="sourceLine" id="cb6-21" data-line-number="21"><span class="co">#&gt; Tracing zero branch</span></a>
<a class="sourceLine" id="cb6-22" data-line-number="22"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb6-23" data-line-number="23"><span class="co">#&gt; tf.Tensor(1.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb6-24" data-line-number="24"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-25" data-line-number="25"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb6-26" data-line-number="26"><span class="co">#&gt; tf.Tensor(positive, shape=(), dtype=string)</span></a>
<a class="sourceLine" id="cb6-27" data-line-number="27"><span class="kw">tf_sign</span>(y)</a>
<a class="sourceLine" id="cb6-28" data-line-number="28"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb6-29" data-line-number="29"><span class="co">#&gt; tf.Tensor(-1.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb6-30" data-line-number="30"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-31" data-line-number="31"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb6-32" data-line-number="32"><span class="co">#&gt; tf.Tensor(negative, shape=(), dtype=string)</span></a>
<a class="sourceLine" id="cb6-33" data-line-number="33"><span class="kw">tf_sign</span>(tf<span class="op">$</span><span class="kw">zeros</span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>()))</a>
<a class="sourceLine" id="cb6-34" data-line-number="34"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb6-35" data-line-number="35"><span class="co">#&gt; tf.Tensor(0.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb6-36" data-line-number="36"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb6-37" data-line-number="37"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb6-38" data-line-number="38"><span class="co">#&gt; tf.Tensor(zero, shape=(), dtype=string)</span></a></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">tf_sign &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/tensorflow/man/tf_function.html">tf_function</a></span>(<span class="kw"><a href="../reference/autograph.html">autograph</a></span>(<span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  <span class="cf">if</span> (x <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">    <span class="dv">1</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">  <span class="cf">else</span> <span class="cf">if</span> (x <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">    <span class="dv">-1</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">  <span class="cf">else</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">    <span class="dv">0</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8">}))</a></code></pre></div>
<p>In eager mode, <code>if(eager_tensor)</code> is translated to <code>if(eager_tensor$`__bool__`())</code>. (Essentially, a slightly more robust way to call <code>eager_tensor$numpy()</code>)</p>
</div>
<div id="while" class="section level4">
<h4 class="hasAnchor">
<a href="#while" class="anchor"></a><code>while</code>
</h4>
<p>In graph mode, <code>while</code> expressions are translated to a <code>tf$while_loop()</code> call.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">naive_factorial &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/tensorflow/man/tf_function.html">tf_function</a></span>(<span class="kw"><a href="../reference/autograph.html">autograph</a></span>(<span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  total &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  <span class="cf">while</span> (x <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">    <span class="kw"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Evaluating while body R expression"</span>)</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">    total <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/magrittr/man/aliases.html">multiply_by</a></span>(x)</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">    x <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/magrittr/man/aliases.html">subtract</a></span>(<span class="kw">tf_sign</span>(x))</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">  }</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">  total</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">}))</a>
<a class="sourceLine" id="cb8-10" data-line-number="10"></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="kw">naive_factorial</span>(x)</a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="co">#&gt; Evaluating while body R expression</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="co">#&gt; tf.Tensor(120.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"><span class="kw">naive_factorial</span>(y)</a>
<a class="sourceLine" id="cb8-15" data-line-number="15"><span class="co">#&gt; tf.Tensor(-120.0, shape=(), dtype=float32)</span></a></code></pre></div>
<p>In eager mode, <code>while(eagor_tensor)</code> is translated to <code>while(as.logical(eager_tensor))</code>. (The <code>tensorflow</code> R package provides tensor methods for many S3 generics, including <code><a href="https://rdrr.io/r/base/logical.html">as.logical()</a></code>).</p>
<p>Here is an example of an autographed <code>while</code> expression being evaluated eagerly. Remember, <code><a href="../reference/autograph.html">autograph()</a></code> is not just for functions!</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">total &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">x</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co">#&gt; tf.Tensor(5.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="kw"><a href="../reference/autograph.html">autograph</a></span>({</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">  <span class="cf">while</span> (x <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">    <span class="kw"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Evaluating while body R expression"</span>)</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">    total <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/magrittr/man/aliases.html">multiply_by</a></span>(x)</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">    x <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/magrittr/man/aliases.html">subtract</a></span>(<span class="kw">tf_sign</span>(x))</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">  }</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">})</a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="co">#&gt; Evaluating while body R expression</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="co">#&gt; Evaluating while body R expression</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="co">#&gt; Evaluating while body R expression</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="co">#&gt; Evaluating while body R expression</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="co">#&gt; Evaluating while body R expression</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16">x</a>
<a class="sourceLine" id="cb9-17" data-line-number="17"><span class="co">#&gt; tf.Tensor(0.0, shape=(), dtype=float32)</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18">total</a>
<a class="sourceLine" id="cb9-19" data-line-number="19"><span class="co">#&gt; tf.Tensor(120.0, shape=(), dtype=float32)</span></a></code></pre></div>
<p><a href="https://www.tensorflow.org/api_docs/python/tf/while_loop"><code>tf.while_loop()</code></a> has many options. In order to pass those through to the call, precede the <code>while</code> expression with <code><a href="../reference/ag_while_opts.html">ag_while_opts()</a></code></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">naive_factorial_serial &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/tensorflow/man/tf_function.html">tf_function</a></span>(<span class="kw"><a href="../reference/autograph.html">autograph</a></span>(<span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  total &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb10-4" data-line-number="4">  <span class="kw"><a href="../reference/ag_while_opts.html">ag_while_opts</a></span>(<span class="dt">parallel_iterations =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">                <span class="dt">back_prop =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">  <span class="cf">while</span> (x <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">    <span class="kw"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Evaluating while body R expression"</span>)</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">    total <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/magrittr/man/aliases.html">multiply_by</a></span>(x)</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">    x <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/magrittr/man/aliases.html">subtract</a></span>(<span class="kw">tf_sign</span>(x))</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">  }</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">  total</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">  }))</a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="kw">naive_factorial</span>(y)</a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="co">#&gt; tf.Tensor(-120.0, shape=(), dtype=float32)</span></a></code></pre></div>
</div>
<div id="for" class="section level4">
<h4 class="hasAnchor">
<a href="#for" class="anchor"></a><code>for</code>
</h4>
<p>Autographed <code>for</code> loops build on top of while loops. Presently, <code>autograph</code> adds support for new types of values passed to <code>for</code>: tfdatasets, tensors, and (in eager mode only) python iterators</p>
<p>In eager mode, both datasets and tensors are coerced to iterators (via <code>iterable$`__iter__`()</code>, through the ergonomic wrapper <code><a href="https://rdrr.io/pkg/reticulate/man/iterate.html">reticulate::as_iterator()</a></code>). The arguments are then iterated over until the iterable is finished. Essentially, a call like</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="cf">for</span>(elem <span class="cf">in</span> iterable) {...}</a></code></pre></div>
<p>gets translated to</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">iterator &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/reticulate/man/iterate.html">as_iterator</a></span>(iterable)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="cf">while</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(elem &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/reticulate/man/iterate.html">iter_next</a></span>(iterator))) {...}</a></code></pre></div>
<p>Note, that tensors are iterated over their first dimension.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">m &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">convert_to_tensor</span>(<span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">12</span>, <span class="dt">nrow =</span> <span class="dv">3</span>, <span class="dt">byrow =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">m</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="co">#&gt; tf.Tensor(</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#&gt; [[ 1  2  3  4]</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">#&gt;  [ 5  6  7  8]</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">#&gt;  [ 9 10 11 12]], shape=(3, 4), dtype=int32)</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="kw"><a href="../reference/autograph.html">autograph</a></span>({</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">  <span class="cf">for</span> (elem <span class="cf">in</span> m)</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">    <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(elem)</a>
<a class="sourceLine" id="cb13-10" data-line-number="10">})</a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="co">#&gt; tf.Tensor([1 2 3 4], shape=(4,), dtype=int32)</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="co">#&gt; tf.Tensor([5 6 7 8], shape=(4,), dtype=int32)</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="co">#&gt; tf.Tensor([ 9 10 11 12], shape=(4,), dtype=int32)</span></a></code></pre></div>
<p>In graph mode, tensors are iterated over within a <code>tf$while_loop()</code>. As such, you can pass additional options via <code><a href="../reference/ag_while_opts.html">ag_while_opts()</a></code> just as you would to an autographed <code>while()</code> expression.</p>
<p>In graph mode, datasets passed to <code>for</code> are translated to a <code>dataset$reduce()</code> call.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">niave_reduce_sum &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/tensorflow/man/tf_function.html">tf_function</a></span>(<span class="kw"><a href="../reference/autograph.html">autograph</a></span>(<span class="cf">function</span>(ds) {</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">  sum &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">zeros</span>(ds<span class="op">$</span>element_spec<span class="op">$</span>shape, <span class="dt">dtype =</span> ds<span class="op">$</span>element_spec<span class="op">$</span>dtype)</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  <span class="cf">for</span> (elem <span class="cf">in</span> ds) {</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">    <span class="kw"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Tracing for loop body"</span>)</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">    sum <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/magrittr/man/aliases.html">add</a></span>(elem)</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">  sum</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">}))</a>
<a class="sourceLine" id="cb14-9" data-line-number="9"></a>
<a class="sourceLine" id="cb14-10" data-line-number="10">ds &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/tfdatasets/man/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(m)</a>
<a class="sourceLine" id="cb14-11" data-line-number="11"><span class="kw">niave_reduce_sum</span>(ds) <span class="co"># loop body is only traced just once on first call</span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="co">#&gt; Tracing for loop body</span></a>
<a class="sourceLine" id="cb14-13" data-line-number="13"><span class="co">#&gt; tf.Tensor([15 18 21 24], shape=(4,), dtype=int32)</span></a>
<a class="sourceLine" id="cb14-14" data-line-number="14"><span class="kw">niave_reduce_sum</span>(ds)</a>
<a class="sourceLine" id="cb14-15" data-line-number="15"><span class="co">#&gt; tf.Tensor([15 18 21 24], shape=(4,), dtype=int32)</span></a></code></pre></div>
<p>Be careful to not pass a dataset that repeats forever! One way to guard against iterating forever is to use <code>take()</code>.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">safe_niave_reduce_sum &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/tensorflow/man/tf_function.html">tf_function</a></span>(<span class="kw"><a href="../reference/autograph.html">autograph</a></span>(<span class="cf">function</span>(ds, <span class="dt">max_iter =</span> <span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">  sum &lt;-<span class="st"> </span>tf<span class="op">$</span><span class="kw">zeros</span>(ds<span class="op">$</span>element_spec<span class="op">$</span>shape, <span class="dt">dtype =</span> ds<span class="op">$</span>element_spec<span class="op">$</span>dtype)</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">  <span class="cf">for</span> (elem <span class="cf">in</span> ds<span class="op">$</span><span class="kw">take</span>(<span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(max_iter))) {</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">    <span class="kw"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Tracing for loop body"</span>)</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">    sum <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/magrittr/man/aliases.html">add</a></span>(elem)</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">  sum</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">}))</a>
<a class="sourceLine" id="cb15-9" data-line-number="9"></a>
<a class="sourceLine" id="cb15-10" data-line-number="10">ds <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/tfdatasets/man/dataset_repeat.html">dataset_repeat</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># repeats infinitly!</span></a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="st">  </span><span class="kw">safe_niave_reduce_sum</span>(<span class="dt">max_iter =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="co">#&gt; Tracing for loop body</span></a>
<a class="sourceLine" id="cb15-14" data-line-number="14"><span class="co">#&gt; tf.Tensor([30 36 42 48], shape=(4,), dtype=int32)</span></a></code></pre></div>
<p>Lets tie some concepts together to write fizzbuzz! Before we do that, we’ll write a helper <code>knitr_log</code>, that will help us capture the output from <code>tf.print</code> in this Rmarkdown vignette. (If we don’t redirect output to a file, then it would show up in the rendering console and not in the vignette)</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">temp_knitr_logfile &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/eval.html">local</a></span>({</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">  LOGFILE &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3">  <span class="cf">function</span>(<span class="dt">what =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"get"</span>, <span class="st">"reset"</span>)) {</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">    <span class="cf">if</span> (<span class="kw"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(LOGFILE))</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">      LOGFILE &lt;&lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"file://%s"</span>, <span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span>())</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">    </a>
<a class="sourceLine" id="cb16-7" data-line-number="7">    what &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/match.arg.html">match.arg</a></span>(what)</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">    <span class="cf">if</span> (what <span class="op">==</span><span class="st"> "reset"</span>)</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">      <span class="kw"><a href="https://rdrr.io/r/base/on.exit.html">on.exit</a></span>({</a>
<a class="sourceLine" id="cb16-10" data-line-number="10">        <span class="kw"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span>(LOGFILE)</a>
<a class="sourceLine" id="cb16-11" data-line-number="11">        LOGFILE &lt;&lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12">      })</a>
<a class="sourceLine" id="cb16-13" data-line-number="13">    </a>
<a class="sourceLine" id="cb16-14" data-line-number="14">    LOGFILE</a>
<a class="sourceLine" id="cb16-15" data-line-number="15">  }</a>
<a class="sourceLine" id="cb16-16" data-line-number="16">})</a>
<a class="sourceLine" id="cb16-17" data-line-number="17"></a>
<a class="sourceLine" id="cb16-18" data-line-number="18">print_temp_knitr_logfile &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">reset =</span> <span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb16-19" data-line-number="19">  filepath &lt;-<span class="st"> </span><span class="kw">temp_knitr_logfile</span>(<span class="cf">if</span>(reset) <span class="st">"reset"</span> <span class="cf">else</span> <span class="st">"get"</span>)</a>
<a class="sourceLine" id="cb16-20" data-line-number="20">  output &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(filepath, <span class="dt">warn =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb16-21" data-line-number="21">  <span class="kw"><a href="https://rdrr.io/r/base/writeLines.html">writeLines</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/strwrap.html">strwrap</a></span>(output))</a>
<a class="sourceLine" id="cb16-22" data-line-number="22">}</a></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">fizzbuzz &lt;-<span class="st"> </span><span class="kw"><a href="../reference/autograph.html">autograph</a></span>(<span class="cf">function</span>(n) {</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://rdrr.io/pkg/tfdatasets/man/range_dataset.html">range_dataset</a></span>(<span class="dt">from =</span> 1L, <span class="dt">to =</span> n)) {</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">    <span class="cf">if</span> (i <span class="op">%%</span><span class="st"> </span>15L <span class="op">==</span><span class="st"> </span>0L)</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">      tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"FizzBuzz"</span>, <span class="dt">end =</span> <span class="st">""</span>, <span class="dt">output_stream =</span> <span class="kw">temp_knitr_logfile</span>())</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">    <span class="cf">else</span> <span class="cf">if</span> (i <span class="op">%%</span><span class="st"> </span>3L <span class="op">==</span><span class="st"> </span>0L)</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">      tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Fizz"</span>, <span class="dt">end =</span> <span class="st">""</span>, <span class="dt">output_stream =</span> <span class="kw">temp_knitr_logfile</span>())</a>
<a class="sourceLine" id="cb17-7" data-line-number="7">    <span class="cf">else</span> <span class="cf">if</span> (i <span class="op">%%</span><span class="st"> </span>5L <span class="op">==</span><span class="st"> </span>0L)</a>
<a class="sourceLine" id="cb17-8" data-line-number="8">      tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Buzz"</span>, <span class="dt">end =</span> <span class="st">""</span>, <span class="dt">output_stream =</span> <span class="kw">temp_knitr_logfile</span>())</a>
<a class="sourceLine" id="cb17-9" data-line-number="9">    <span class="cf">else</span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10">      tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(i, <span class="dt">end =</span> <span class="st">""</span>, <span class="dt">output_stream =</span> <span class="kw">temp_knitr_logfile</span>())</a>
<a class="sourceLine" id="cb17-11" data-line-number="11">    </a>
<a class="sourceLine" id="cb17-12" data-line-number="12">    <span class="cf">if</span>(i <span class="op">&lt;</span><span class="st"> </span>tf<span class="op">$</span><span class="kw">cast</span>(n<span class="op">-</span>1L, i<span class="op">$</span>dtype))</a>
<a class="sourceLine" id="cb17-13" data-line-number="13">      tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">", "</span>, <span class="dt">end =</span> <span class="st">""</span>, <span class="dt">output_stream =</span> <span class="kw">temp_knitr_logfile</span>())</a>
<a class="sourceLine" id="cb17-14" data-line-number="14">  }</a>
<a class="sourceLine" id="cb17-15" data-line-number="15">})</a></code></pre></div>
<p>First, lets run it in eager mode.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">fizzbuzz</span>(tf<span class="op">$</span><span class="kw">constant</span>(25L))</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="kw">print_temp_knitr_logfile</span>()</a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="co">#&gt; 1, 2, Fizz, 4, Buzz, Fizz, 7, 8, Fizz, Buzz, 11, Fizz, 13, 14,</span></a>
<a class="sourceLine" id="cb18-4" data-line-number="4"><span class="co">#&gt; FizzBuzz, 16, 17, Fizz, 19, Buzz, Fizz, 22, 23, Fizz</span></a></code></pre></div>
<p>And now in graph mode.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">fizzbuzz &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/tensorflow/man/tf_function.html">tf_function</a></span>(fizzbuzz)</a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="kw">fizzbuzz</span>(tf<span class="op">$</span><span class="kw">constant</span>(25L))</a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="kw">print_temp_knitr_logfile</span>()</a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="co">#&gt; 1, 2, Fizz, 4, Buzz, Fizz, 7, 8, Fizz, Buzz, 11, Fizz, 13, 14,</span></a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="co">#&gt; FizzBuzz, 16, 17, Fizz, 19, Buzz, Fizz, 22, 23, Fizz</span></a></code></pre></div>
</div>
<div id="break-next" class="section level4">
<h4 class="hasAnchor">
<a href="#break-next" class="anchor"></a><code>break</code> / <code>next</code>
</h4>
<p><code>while</code> and <code>for</code> both can accept <code>break</code> and <code>next</code> statements, both in eager mode and in graph mode.</p>
</div>
<div id="passing-additional-options" class="section level4">
<h4 class="hasAnchor">
<a href="#passing-additional-options" class="anchor"></a>Passing additional options</h4>
</div>
<div id="providing-hints" class="section level4">
<h4 class="hasAnchor">
<a href="#providing-hints" class="anchor"></a>Providing hints</h4>
</div>
<div id="control-dependencies" class="section level4">
<h4 class="hasAnchor">
<a href="#control-dependencies" class="anchor"></a>Control Dependencies</h4>
</div>
<div id="view-graph" class="section level4">
<h4 class="hasAnchor">
<a href="#view-graph" class="anchor"></a>View graph</h4>
</div>
<div id="growing-objects-tensorarrays" class="section level4">
<h4 class="hasAnchor">
<a href="#growing-objects-tensorarrays" class="anchor"></a>Growing Objects / TensorArrays</h4>
</div>
<div id="how-it-works" class="section level4">
<h4 class="hasAnchor">
<a href="#how-it-works" class="anchor"></a>How it works</h4>
</div>
</div>
<div id="demo-full-mnist-training-loop" class="section level1">
<h1 class="hasAnchor">
<a href="#demo-full-mnist-training-loop" class="anchor"></a>Demo – Full MNIST Training Loop</h1>
<p>Here is a full MNIST training loop implemented in R using tfautograph. (adapted from <a href="https://www.tensorflow.org/beta/guide/autograph">here</a>)</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(magrittr)</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(purrr, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb20-3" data-line-number="3"></a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tensorflow)</a>
<a class="sourceLine" id="cb20-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tfdatasets)</a>
<a class="sourceLine" id="cb20-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(keras)</a>
<a class="sourceLine" id="cb20-7" data-line-number="7"></a>
<a class="sourceLine" id="cb20-8" data-line-number="8"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tfautograph)</a>
<a class="sourceLine" id="cb20-9" data-line-number="9"></a>
<a class="sourceLine" id="cb20-10" data-line-number="10"><span class="kw"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="dt">list =</span> <span class="kw"><a href="https://rdrr.io/r/base/ls.html">ls</a></span>()) <span class="co"># clear the global env</span></a>
<a class="sourceLine" id="cb20-11" data-line-number="11"></a>
<a class="sourceLine" id="cb20-12" data-line-number="12"><span class="co"># reticulate::use_virtualenv("tf2-nightly")</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13"></a>
<a class="sourceLine" id="cb20-14" data-line-number="14"><span class="co"># All of tfautograph works in tf 1.14 also, but this readme expects 2.0.</span></a>
<a class="sourceLine" id="cb20-15" data-line-number="15">tf<span class="op">$</span>version<span class="op">$</span>VERSION</a>
<a class="sourceLine" id="cb20-16" data-line-number="16"><span class="co">#&gt; [1] "2.0.0-dev20190919"</span></a>
<a class="sourceLine" id="cb20-17" data-line-number="17"><span class="kw"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/tensorflow/man/tf_config.html">tf_version</a></span>() <span class="op">&gt;=</span><span class="st"> "2"</span>)</a></code></pre></div>
<div id="download-data" class="section level3">
<h3 class="hasAnchor">
<a href="#download-data" class="anchor"></a>Download data</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">prepare_mnist_features_and_labels &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">  x =<span class="st"> </span>tf<span class="op">$</span><span class="kw">cast</span>(x, tf<span class="op">$</span>float32) <span class="op">/</span><span class="st"> </span><span class="dv">255</span></a>
<a class="sourceLine" id="cb21-3" data-line-number="3">  y =<span class="st"> </span>tf<span class="op">$</span><span class="kw">cast</span>(y, tf<span class="op">$</span>int64)</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(x, y)</a>
<a class="sourceLine" id="cb21-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb21-6" data-line-number="6"></a>
<a class="sourceLine" id="cb21-7" data-line-number="7">mnist_dataset &lt;-<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb21-8" data-line-number="8">  <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(x, y), .) <span class="op">%&lt;-%</span><span class="st"> </span>tf<span class="op">$</span>keras<span class="op">$</span>datasets<span class="op">$</span>mnist<span class="op">$</span><span class="kw">load_data</span>()</a>
<a class="sourceLine" id="cb21-9" data-line-number="9">  <span class="kw"><a href="https://rdrr.io/pkg/tfdatasets/man/tensor_slices_dataset.html">tensor_slices_dataset</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(x, y)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-10" data-line-number="10"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/pkg/tfdatasets/man/dataset_map.html">dataset_map</a></span>(prepare_mnist_features_and_labels) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-11" data-line-number="11"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/pkg/tfdatasets/man/dataset_take.html">dataset_take</a></span>(<span class="dv">20000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-12" data-line-number="12"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/pkg/tfdatasets/man/dataset_shuffle.html">dataset_shuffle</a></span>(<span class="dv">20000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-13" data-line-number="13"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/pkg/tfdatasets/man/dataset_batch.html">dataset_batch</a></span>(<span class="dv">100</span>)</a>
<a class="sourceLine" id="cb21-14" data-line-number="14">}</a>
<a class="sourceLine" id="cb21-15" data-line-number="15"></a>
<a class="sourceLine" id="cb21-16" data-line-number="16">train_dataset &lt;-<span class="st"> </span><span class="kw">mnist_dataset</span>()</a></code></pre></div>
</div>
<div id="define-the-model" class="section level3">
<h3 class="hasAnchor">
<a href="#define-the-model" class="anchor"></a>Define the model</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">new_model_and_optimizer &lt;-<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">  model &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_reshape.html">layer_reshape</a></span>(<span class="dt">target_shape =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">28</span> <span class="op">*</span><span class="st"> </span><span class="dv">28</span>),</a>
<a class="sourceLine" id="cb22-4" data-line-number="4">                  <span class="dt">input_shape =</span> <span class="kw"><a href="https://rdrr.io/pkg/tensorflow/man/shape.html">shape</a></span>(<span class="dv">28</span>, <span class="dv">28</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span>(<span class="dv">100</span>, <span class="dt">activation =</span> <span class="st">'relu'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span>(<span class="dv">100</span>, <span class="dt">activation =</span> <span class="st">'relu'</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="st">    </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb22-8" data-line-number="8">  model<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/utils/PkgUtils.html">build</a></span>()</a>
<a class="sourceLine" id="cb22-9" data-line-number="9">  optimizer &lt;-<span class="st"> </span>tf<span class="op">$</span>keras<span class="op">$</span>optimizers<span class="op">$</span><span class="kw">Adam</span>()</a>
<a class="sourceLine" id="cb22-10" data-line-number="10">  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(model, optimizer)</a>
<a class="sourceLine" id="cb22-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb22-12" data-line-number="12"><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(model, optimizer) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">new_model_and_optimizer</span>()</a></code></pre></div>
</div>
<div id="define-the-training-loop" class="section level3">
<h3 class="hasAnchor">
<a href="#define-the-training-loop" class="anchor"></a>Define the training loop</h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">compute_loss &lt;-<span class="st"> </span>tf<span class="op">$</span>keras<span class="op">$</span>losses<span class="op">$</span><span class="kw">SparseCategoricalCrossentropy</span>(<span class="dt">from_logits =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">compute_accuracy &lt;-<span class="st"> </span>tf<span class="op">$</span>keras<span class="op">$</span>metrics<span class="op">$</span><span class="kw">SparseCategoricalAccuracy</span>()</a>
<a class="sourceLine" id="cb23-3" data-line-number="3"></a>
<a class="sourceLine" id="cb23-4" data-line-number="4">train_one_step &lt;-<span class="st"> </span><span class="cf">function</span>(model, optimizer, x, y) {</a>
<a class="sourceLine" id="cb23-5" data-line-number="5">  <span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(tf<span class="op">$</span><span class="kw">GradientTape</span>() <span class="op">%as%</span><span class="st"> </span>tape, {</a>
<a class="sourceLine" id="cb23-6" data-line-number="6">    logits &lt;-<span class="st"> </span><span class="kw">model</span>(x)</a>
<a class="sourceLine" id="cb23-7" data-line-number="7">    loss &lt;-<span class="st"> </span><span class="kw">compute_loss</span>(y, logits)</a>
<a class="sourceLine" id="cb23-8" data-line-number="8">  })</a>
<a class="sourceLine" id="cb23-9" data-line-number="9"></a>
<a class="sourceLine" id="cb23-10" data-line-number="10">  grads &lt;-<span class="st"> </span>tape<span class="op">$</span><span class="kw">gradient</span>(loss, model<span class="op">$</span>trainable_variables)</a>
<a class="sourceLine" id="cb23-11" data-line-number="11">  optimizer<span class="op">$</span><span class="kw">apply_gradients</span>(</a>
<a class="sourceLine" id="cb23-12" data-line-number="12">    <span class="kw"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(grads, model<span class="op">$</span>trainable_variables)))</a>
<a class="sourceLine" id="cb23-13" data-line-number="13"></a>
<a class="sourceLine" id="cb23-14" data-line-number="14">  <span class="kw">compute_accuracy</span>(y, logits)</a>
<a class="sourceLine" id="cb23-15" data-line-number="15">  loss</a>
<a class="sourceLine" id="cb23-16" data-line-number="16">}</a>
<a class="sourceLine" id="cb23-17" data-line-number="17"></a>
<a class="sourceLine" id="cb23-18" data-line-number="18"></a>
<a class="sourceLine" id="cb23-19" data-line-number="19">train &lt;-<span class="st"> </span><span class="kw"><a href="../reference/autograph.html">autograph</a></span>(<span class="cf">function</span>(model, optimizer) {</a>
<a class="sourceLine" id="cb23-20" data-line-number="20">  step &lt;-<span class="st"> </span>0L</a>
<a class="sourceLine" id="cb23-21" data-line-number="21">  loss &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb23-22" data-line-number="22">  <span class="cf">for</span> (batch <span class="cf">in</span> train_dataset) {</a>
<a class="sourceLine" id="cb23-23" data-line-number="23">    <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(x, y) <span class="op">%&lt;-%</span><span class="st"> </span>batch</a>
<a class="sourceLine" id="cb23-24" data-line-number="24">    step <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/magrittr/man/aliases.html">add</a></span>(1L)</a>
<a class="sourceLine" id="cb23-25" data-line-number="25">    loss &lt;-<span class="st"> </span><span class="kw">train_one_step</span>(model, optimizer, x, y)</a>
<a class="sourceLine" id="cb23-26" data-line-number="26">    <span class="cf">if</span> (compute_accuracy<span class="op">$</span><span class="kw">result</span>() <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.8</span>) {</a>
<a class="sourceLine" id="cb23-27" data-line-number="27">      tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>( <span class="st">'Step'</span>, step, <span class="st">': loss'</span>, loss, <span class="st">'; accuracy'</span>, compute_accuracy<span class="op">$</span><span class="kw">result</span>(),</a>
<a class="sourceLine" id="cb23-28" data-line-number="28">        <span class="dt">output_stream =</span> log_file)</a>
<a class="sourceLine" id="cb23-29" data-line-number="29">      <span class="co"># We direct all tf$print() outputs to a log file only so that Rmarkdown can</span></a>
<a class="sourceLine" id="cb23-30" data-line-number="30">      <span class="co"># show output that would otherwise just go to stdout</span></a>
<a class="sourceLine" id="cb23-31" data-line-number="31">      tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Breaking early"</span>, <span class="dt">output_stream =</span> log_file)</a>
<a class="sourceLine" id="cb23-32" data-line-number="32">      <span class="cf">break</span></a>
<a class="sourceLine" id="cb23-33" data-line-number="33">    } <span class="cf">else</span> <span class="cf">if</span> (step <span class="op">%%</span><span class="st"> </span>10L <span class="op">==</span><span class="st"> </span>0L)</a>
<a class="sourceLine" id="cb23-34" data-line-number="34">      tf<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">'Step'</span>, step, <span class="st">': loss'</span>, loss,</a>
<a class="sourceLine" id="cb23-35" data-line-number="35">               <span class="st">'; accuracy'</span>, compute_accuracy<span class="op">$</span><span class="kw">result</span>(), </a>
<a class="sourceLine" id="cb23-36" data-line-number="36">               <span class="dt">output_stream =</span> log_file)</a>
<a class="sourceLine" id="cb23-37" data-line-number="37">  }</a>
<a class="sourceLine" id="cb23-38" data-line-number="38">  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(step, loss)</a>
<a class="sourceLine" id="cb23-39" data-line-number="39">})</a></code></pre></div>
</div>
<div id="train-in-graph-mode" class="section level3">
<h3 class="hasAnchor">
<a href="#train-in-graph-mode" class="anchor"></a>train in graph mode</h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"></a>
<a class="sourceLine" id="cb24-2" data-line-number="2">log_file &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"file://%s"</span>, <span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span>(<span class="st">"TF-print-log"</span>, <span class="dt">fileext =</span> <span class="st">".out"</span>))</a>
<a class="sourceLine" id="cb24-3" data-line-number="3"></a>
<a class="sourceLine" id="cb24-4" data-line-number="4">train_graph &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/tensorflow/man/tf_function.html">tf_function</a></span>(train)</a>
<a class="sourceLine" id="cb24-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(step, loss) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">train_graph</span>(model, optimizer)</a>
<a class="sourceLine" id="cb24-6" data-line-number="6"></a>
<a class="sourceLine" id="cb24-7" data-line-number="7"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(log_file), <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</a>
<a class="sourceLine" id="cb24-8" data-line-number="8"><span class="co">#&gt; Step 10 : loss 1.85243869 ; accuracy 0.356</span></a>
<a class="sourceLine" id="cb24-9" data-line-number="9"><span class="co">#&gt; Step 20 : loss 1.17494774 ; accuracy 0.516</span></a>
<a class="sourceLine" id="cb24-10" data-line-number="10"><span class="co">#&gt; Step 30 : loss 0.722453892 ; accuracy 0.61</span></a>
<a class="sourceLine" id="cb24-11" data-line-number="11"><span class="co">#&gt; Step 40 : loss 0.355527043 ; accuracy 0.6655</span></a>
<a class="sourceLine" id="cb24-12" data-line-number="12"><span class="co">#&gt; Step 50 : loss 0.368761748 ; accuracy 0.7038</span></a>
<a class="sourceLine" id="cb24-13" data-line-number="13"><span class="co">#&gt; Step 60 : loss 0.435298115 ; accuracy 0.732333362</span></a>
<a class="sourceLine" id="cb24-14" data-line-number="14"><span class="co">#&gt; Step 70 : loss 0.487007231 ; accuracy 0.751857162</span></a>
<a class="sourceLine" id="cb24-15" data-line-number="15"><span class="co">#&gt; Step 80 : loss 0.598308742 ; accuracy 0.769375</span></a>
<a class="sourceLine" id="cb24-16" data-line-number="16"><span class="co">#&gt; Step 90 : loss 0.213884637 ; accuracy 0.784</span></a>
<a class="sourceLine" id="cb24-17" data-line-number="17"><span class="co">#&gt; Step 100 : loss 0.444704711 ; accuracy 0.7958</span></a>
<a class="sourceLine" id="cb24-18" data-line-number="18"><span class="co">#&gt; Step 105 : loss 0.325794905 ; accuracy 0.80066669</span></a>
<a class="sourceLine" id="cb24-19" data-line-number="19"><span class="co">#&gt; Breaking early</span></a>
<a class="sourceLine" id="cb24-20" data-line-number="20"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(</a>
<a class="sourceLine" id="cb24-21" data-line-number="21">  <span class="st">'Final step %i: loss %.6f; accuracy %.6f'</span>,</a>
<a class="sourceLine" id="cb24-22" data-line-number="22">  <span class="kw"><a href="https://rdrr.io/r/base/array.html">as.array</a></span>(step), <span class="kw"><a href="https://rdrr.io/r/base/array.html">as.array</a></span>(loss), <span class="kw"><a href="https://rdrr.io/r/base/array.html">as.array</a></span>(compute_accuracy<span class="op">$</span><span class="kw">result</span>())))</a>
<a class="sourceLine" id="cb24-23" data-line-number="23"><span class="co">#&gt; Final step 105: loss 0.325795; accuracy 0.800667</span></a></code></pre></div>
</div>
<div id="train-in-eager-mode" class="section level3">
<h3 class="hasAnchor">
<a href="#train-in-eager-mode" class="anchor"></a>train in eager mode</h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="co"># autograph also works in eager mode</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2"></a>
<a class="sourceLine" id="cb25-3" data-line-number="3">log_file &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"file://%s"</span>, <span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span>(<span class="st">"TF-print-log"</span>, <span class="dt">fileext =</span> <span class="st">".out"</span>))</a>
<a class="sourceLine" id="cb25-4" data-line-number="4"></a>
<a class="sourceLine" id="cb25-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(model, optimizer) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">new_model_and_optimizer</span>()</a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(step, loss) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/tensorflow/man/train.html">train</a></span>(model, optimizer)</a>
<a class="sourceLine" id="cb25-7" data-line-number="7"></a>
<a class="sourceLine" id="cb25-8" data-line-number="8"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(log_file), <span class="dt">sep =</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</a>
<a class="sourceLine" id="cb25-9" data-line-number="9"><span class="co">#&gt; Step 10 : loss 1.67560041 ; accuracy 0.759565234</span></a>
<a class="sourceLine" id="cb25-10" data-line-number="10"><span class="co">#&gt; Step 20 : loss 1.31256914 ; accuracy 0.74864</span></a>
<a class="sourceLine" id="cb25-11" data-line-number="11"><span class="co">#&gt; Step 30 : loss 0.799078 ; accuracy 0.75222224</span></a>
<a class="sourceLine" id="cb25-12" data-line-number="12"><span class="co">#&gt; Step 40 : loss 0.444458544 ; accuracy 0.756344855</span></a>
<a class="sourceLine" id="cb25-13" data-line-number="13"><span class="co">#&gt; Step 50 : loss 0.464065641 ; accuracy 0.761354864</span></a>
<a class="sourceLine" id="cb25-14" data-line-number="14"><span class="co">#&gt; Step 60 : loss 0.490700364 ; accuracy 0.766727269</span></a>
<a class="sourceLine" id="cb25-15" data-line-number="15"><span class="co">#&gt; Step 70 : loss 0.300326228 ; accuracy 0.773771405</span></a>
<a class="sourceLine" id="cb25-16" data-line-number="16"><span class="co">#&gt; Step 80 : loss 0.392836303 ; accuracy 0.779351354</span></a>
<a class="sourceLine" id="cb25-17" data-line-number="17"><span class="co">#&gt; Step 90 : loss 0.40613243 ; accuracy 0.784923077</span></a>
<a class="sourceLine" id="cb25-18" data-line-number="18"><span class="co">#&gt; Step 100 : loss 0.38110882 ; accuracy 0.790390253</span></a>
<a class="sourceLine" id="cb25-19" data-line-number="19"><span class="co">#&gt; Step 110 : loss 0.330836147 ; accuracy 0.795488358</span></a>
<a class="sourceLine" id="cb25-20" data-line-number="20"><span class="co">#&gt; Step 120 : loss 0.310960203 ; accuracy 0.800444424</span></a>
<a class="sourceLine" id="cb25-21" data-line-number="21"><span class="co">#&gt; Breaking early</span></a>
<a class="sourceLine" id="cb25-22" data-line-number="22"><span class="kw"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(</a>
<a class="sourceLine" id="cb25-23" data-line-number="23">  <span class="st">'Final step %i: loss %.6f; accuracy %.6f'</span>,</a>
<a class="sourceLine" id="cb25-24" data-line-number="24">  <span class="kw"><a href="https://rdrr.io/r/base/array.html">as.array</a></span>(step), <span class="kw"><a href="https://rdrr.io/r/base/array.html">as.array</a></span>(loss), <span class="kw"><a href="https://rdrr.io/r/base/array.html">as.array</a></span>(compute_accuracy<span class="op">$</span><span class="kw">result</span>())))</a>
<a class="sourceLine" id="cb25-25" data-line-number="25"><span class="co">#&gt; Final step 120: loss 0.310960; accuracy 0.800444</span></a></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#demo-full-mnist-training-loop">Demo – Full MNIST Training Loop</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Tomasz Kalinowski.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
